"""
ç¬¬3å‘¨-Part3ï¼šä½ çš„ç¬¬ä¸€æ¬¡AIå¯¹è¯ï¼ˆé‡åŒ–åˆ†æç‰ˆï¼‰
============================================
ä»ç®€å•å¯¹è¯åˆ°ç»“æ„åŒ–åˆ†æï¼Œé€æ­¥å‡çº§
"""

import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).resolve().parent.parent.parent))

from quant_core.ai import DeepSeekClient
from quant_core.data import fetch_stock
import pandas as pd

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# å®éªŒ1ï¼šæœ€ç®€å•çš„å¯¹è¯
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

print("=" * 60)
print("ğŸ§ª å®éªŒ1ï¼šæœ€ç®€å•çš„å¯¹è¯")
print("=" * 60)

client = DeepSeekClient()  # é»˜è®¤ä½¿ç”¨DeepSeek-V3

# å…ˆçœ‹çœ‹è´¹ç”¨ï¼ˆä¸èŠ±é’±ï¼‰
question = "ä»€ä¹ˆæ˜¯é‡åŒ–äº¤æ˜“ï¼Ÿç”¨3å¥è¯è§£é‡Šã€‚"
cost = client.estimate_cost(question, output_tokens=200)
print(f"\nğŸ“Š è´¹ç”¨é¢„ä¼°ï¼š{cost}")

# å‘é€è¯·æ±‚ï¼ˆèŠ±é’±äº†ï¼Œä½†å¾ˆå°‘ï¼‰
answer = client.chat(question)
print(f"\nâ“ é—®é¢˜ï¼š{question}")
print(f"ğŸ¤– å›ç­”ï¼š{answer}")


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# å®éªŒ2ï¼šè®¾ç½®System Promptï¼ˆè§’è‰²æ‰®æ¼”ï¼‰
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

print("\n" + "=" * 60)
print("ğŸ§ª å®éªŒ2ï¼šè®¾ç½®è§’è‰²â€”â€”é‡åŒ–åˆ†æå¸ˆ")
print("=" * 60)

# è®¾å®š"é‡åŒ–åˆ†æå¸ˆ"è§’è‰²
client.set_system_prompt("""
ä½ æ˜¯ä¸€ä½èµ„æ·±é‡åŒ–åˆ†æå¸ˆï¼Œæ‹¥æœ‰10å¹´Aè‚¡æŠ•èµ„ç»éªŒå’ŒCFAèµ„æ ¼ã€‚
ä½ çš„èŒè´£ï¼š
1. åŸºäºæ•°æ®è¿›è¡Œå®¢è§‚åˆ†æï¼Œä¸å¸¦ä¸»è§‚æƒ…ç»ª
2. æ°¸è¿œç»™å‡ºæ•°æ®æ”¯æ’‘ï¼Œä¸è¯´ç©ºè¯
3. æ˜ç¡®æŒ‡å‡ºåˆ†æçš„å±€é™æ€§å’Œé£é™©
4. ä½¿ç”¨ä¸“ä¸šä½†æ˜“æ‡‚çš„è¯­è¨€

ä½ ä¸ä¼šï¼š
1. ç»™å‡ºæ˜ç¡®çš„"ä¹°å…¥/å–å‡º"å»ºè®®ï¼ˆåˆè§„è¦æ±‚ï¼‰
2. é¢„æµ‹å…·ä½“ä»·æ ¼ç›®æ ‡
3. ç¼–é€ ä¸å­˜åœ¨çš„æ•°æ®
""")

answer = client.chat("è¯·ç®€è¦åˆ†æä¸€ä¸‹å½“å‰Aè‚¡æ¶ˆè´¹æ¿å—çš„æŠ•èµ„é€»è¾‘")
print(f"\nğŸ¤– é‡åŒ–åˆ†æå¸ˆï¼š\n{answer}")


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# å®éªŒ3ï¼šç”¨çœŸå®æ•°æ® + AIåˆ†æï¼ˆæ ¸å¿ƒåœºæ™¯ï¼ï¼‰
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

print("\n" + "=" * 60)
print("ğŸ§ª å®éªŒ3ï¼šçœŸå®æ•°æ® + AIåˆ†æï¼ˆé‡åŒ–3.0æ ¸å¿ƒæµç¨‹ï¼‰")
print("=" * 60)

# ç¬¬ä¸€æ­¥ï¼šè·å–çœŸå®æ•°æ®
df = fetch_stock("600519", days=60)

# ç¬¬äºŒæ­¥ï¼šè®¡ç®—å…³é”®æŒ‡æ ‡
df["sma5"]  = df["close"].rolling(5).mean()
df["sma20"] = df["close"].rolling(20).mean()
df["daily_return"] = df["close"].pct_change()
latest = df.iloc[-1]

# ç¬¬ä¸‰æ­¥ï¼šæ„å»ºæ•°æ®æ‘˜è¦ï¼ˆæŠŠæ•°æ®å˜æˆAIèƒ½ç†è§£çš„æ–‡å­—ï¼‰
data_summary = f"""
## è´µå·èŒ…å°(600519) æ•°æ®æ‘˜è¦
- æ•°æ®æˆªæ­¢æ—¥: {df.index[-1].strftime('%Y-%m-%d')}
- æœ€æ–°æ”¶ç›˜ä»·: {latest['close']:.2f} å…ƒ
- 5æ—¥å‡çº¿ (MA5ï¼Œæœ€è¿‘5å¤©æ”¶ç›˜ä»·å¹³å‡å€¼): {latest['sma5']:.2f} å…ƒ
- 20æ—¥å‡çº¿ (MA20ï¼Œæœ€è¿‘20å¤©æ”¶ç›˜ä»·å¹³å‡å€¼): {latest['sma20']:.2f} å…ƒ
- MA5 vs MA20: {"MA5åœ¨MA20ä¸Šæ–¹ï¼ˆçŸ­æœŸè¶‹åŠ¿åå¼ºï¼‰" if latest['sma5'] > latest['sma20'] else "MA5åœ¨MA20ä¸‹æ–¹ï¼ˆçŸ­æœŸè¶‹åŠ¿åå¼±ï¼‰"}
- æœ€è¿‘5æ—¥å¹³å‡æ¶¨è·Œå¹…: {df['daily_return'].tail(5).mean():.4%}
- æœ€è¿‘20æ—¥æ³¢åŠ¨ç‡ï¼ˆæ—¥æ”¶ç›Šç‡æ ‡å‡†å·®ï¼‰: {df['daily_return'].tail(20).std():.4%}
- æœ€è¿‘20æ—¥æœ€é«˜ä»·: {df['high'].tail(20).max():.2f} å…ƒ
- æœ€è¿‘20æ—¥æœ€ä½ä»·: {df['low'].tail(20).min():.2f} å…ƒ
- æœ€è¿‘5æ—¥å¹³å‡æ¢æ‰‹ç‡: {df['turnover'].tail(5).mean():.2f}%
"""

# ç¬¬å››æ­¥ï¼šè®©AIåˆ†æ
prompt = f"""
è¯·åŸºäºä»¥ä¸‹çœŸå®æ•°æ®ï¼Œå¯¹è´µå·èŒ…å°è¿›è¡ŒæŠ€æœ¯é¢åˆ†æã€‚

{data_summary}

è¯·ä»ä»¥ä¸‹è§’åº¦åˆ†æï¼š
1. å½“å‰è¶‹åŠ¿åˆ¤æ–­ï¼ˆä¸Šæ¶¨/éœ‡è¡/ä¸‹è·Œï¼‰ï¼Œå¹¶è¯´æ˜åˆ¤æ–­ä¾æ®
2. å…³é”®æ”¯æ’‘ä½å’Œå‹åŠ›ä½åœ¨å“ªé‡Œï¼Œä¸ºä»€ä¹ˆ
3. æˆäº¤æ´»è·ƒåº¦è¯„ä¼°ï¼ˆæ¢æ‰‹ç‡æ°´å¹³ï¼‰
4. çŸ­æœŸé£é™©æç¤ºï¼ˆ3-5ä¸ªäº¤æ˜“æ—¥ï¼‰
5. éœ€è¦å…³æ³¨çš„ä¿¡å·ï¼ˆä»€ä¹ˆæƒ…å†µä¸‹è¶‹åŠ¿å¯èƒ½åè½¬ï¼‰

æ³¨æ„ï¼šåˆ†æåŸºäºå†å²æ•°æ®ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚
"""

answer = client.chat(prompt, temperature=0.1)
print(f"\nğŸ¤– AIæŠ€æœ¯é¢åˆ†æï¼š\n{answer}")


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# å®éªŒ4ï¼šTemperatureï¼ˆæ¸©åº¦ï¼‰å¯¹æ¯”å®éªŒ
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

print("\n" + "=" * 60)
print("ğŸ§ª å®éªŒ4ï¼šTemperatureå¯¹æ¯”ï¼ˆåŒä¸€é—®é¢˜ä¸åŒæ¸©åº¦ï¼‰")
print("=" * 60)

question = "ç”¨ä¸€å¥è¯æè¿°è´µå·èŒ…å°çš„æŠ•èµ„ç‰¹ç‚¹"

for temp in [0.0, 0.5, 1.0, 1.5]:
    answer = client.chat(question, temperature=temp)
    print(f"\n  ğŸŒ¡ï¸ temperature={temp}: {answer}")

print("""
  ğŸ’¡ è§‚å¯Ÿï¼š
     temperature=0.0 â†’ æ¯æ¬¡å›ç­”å‡ ä¹ä¸€æ ·ï¼Œæœ€ç²¾ç¡®
     temperature=0.5 â†’ ç•¥æœ‰å˜åŒ–ï¼Œä½†æ ¸å¿ƒè§‚ç‚¹ä¸€è‡´
     temperature=1.0 â†’ å¼€å§‹æœ‰ä¸åŒè§’åº¦å’Œè¡¨è¿°
     temperature=1.5 â†’ è¡¨è¿°æ›´è‡ªç”±ï¼Œå¯èƒ½å‡ºç°æ„å¤–è§‚ç‚¹
     
     é‡åŒ–åˆ†ææ¨è 0~0.3ï¼Œç­–ç•¥å¤´è„‘é£æš´å¯ä»¥ç”¨ 0.5~0.8
""")